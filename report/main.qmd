---
title: HW2
author: Yian Lin, Haibo Wu, Wakeel Adekunle Kasali
date: 2024-03-01
format: 
  pdf :
    fontsize: 12pt
header-includes: 
  \usepackage{caption}
  \newcommand{\beginAppendix}{
    \setcounter{table}{0}  
    \renewcommand{\thetable}{A\arabic{table}}}
bibliography: ../references/hw2.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

```{r}
library(tidyverse)
library(rmiss)
library(knitr)
library(here)
```

# Introduction
Consumer behavior regarding daily beverage choices is widely observed, with zero-calorie drinks usually considered as a healthier option. It is reasonable to surmise that methods of sale might impact the sales dynamics of zero-calorie beverages. This study aims to investigate which alternative methods are most effective in encouraging the purchase of zero-calorie drinks. Specifically, there are two primary intervention strategies of interest: one that highlighting the average calorie content in each beverage and/or the amount of exercise needed to burn those calories, and another providing discount information along with explanations for the discounts. To determine the key factors of effect, the consumption patterns of various beverages are compared under the different interventions. The main statistical questions we aim to address include: (1) How do different intervention strategies affect the sales of zero-calorie and sugary beverages, and which strategies are more impactful;
 (2) Whether the effectiveness of the interventions change with site; (3) Compared to the mere numerical values of calorie, if the calorie-relevant information is more effective.
 
 (Further consideration needed) With the given information, we will be approaching the questions and providing  statistical advice in the following ways:
  
 *  We will employ appropriate time series analysis models to determine the potential impacts of time cycle on experimental outcomes.
 *  We will use relevant linear mixed models and hypothesis testing methods to determine the effects of different interventions and capture variations by site.
 *  Based on the results above, we will answer the key statistical questions and then give our suggestions for possible  further analysis.
 
 In the diminishing consumption rate of sugary drinks, health awareness is noticed as playing an imaginable role in reshaping modern dietary habits. This is distinctly apparent in the context of sugary beverage consumption, which often poses health concerns as a result of its association with several health challenges like obesity, diabetes, and tooth decay.


By acknowledging the critical nature of this topic, our study aims to explore and evaluate ways to steer consumer behavior toward healthier drink choices effectively. 
The primary objective of this study is to assess the efficacy of various interventions - a 10% Price Discount on Zero-Calorie Beverages, a 10% Price Discount Plus Explanatory Messaging, Calorie Content Messaging, Physical Activity Equivalent Messaging, Combination of Calorie Content and Physical Activity Equivalent Messaging - in fostering zero-calorie beverage consumption.

While conducted in two urban and one suburban hospital, the study applies an interrupted time-series model to examine the consequence of the interventions, offering a reliable framework for analyzing changes over time.


The study aims to answer several statistical questions:

1. Do the interventions significantly influence the sale of zero-calorie and sugary beverages, and which intervention seems most effective?
2. Does the intervention effectiveness vary between urban and suburban hospital environments?
3. Does a combination of price discounts and explanatory messaging more substantially influence consumer choices than when applied separately?
4. How does the impact of calorie-equivalent messaging on consumer beverage selection compare with that of simple calorie information?



# Data Summary
This is a quasi-experiment study for investigating the effects of five interventions  on consumer inclination towards zero-calorie beverages. The dataset contains the daily sales of different types of beverages (including zero-calorie, sugared and others) under various interventions across three sites, from October 27 to May 23. In this study, the daily sales of each type of beverage are used for measuring the consumers' preference on this type of beverage. The crucial variables are the daily sales of zero-calorie beverages, sugared beverages and total of all the beverages, which are measured as continuous data. On the other hand, based on the objectives of the study, the site and intervention should be treated as categorical variables for further analysis, and the days of week are also recorded as a categorical variable to determine potential impacts of time on the outcomes. Additionally, the dataset includes a time-counting variable that captures the timeline of the entire experiment, indicating that each site has around 220 time points. For the entire dataset, the records of these key variables are relatively complete, with sugared and zero-calorie beverages having only a negligible amount of missing data. However, records for other types of beverages show a certain proportion of missing data, which can be considered as missing completely at random based on the given information. 
 
# EDA Analysis
Before doing any analysis, it is important to first assess data missingness. A graph (like Figure 1) can be drawn to visualize the proportion of missing values for all columns in the data set. If there are missing data, it is suggested to create a table to show the data missingness by `Site` for columns with missing data (see Table 1). To see from which intervention type the missing data comes from, an expanded table can be made to show the data missingness by `Site` and `Intervention` for columns with missing data (see Table A1 in Appendix). For columns that will be used in the analysis to answer the research question, it is important to find out why the data are missing.

```{r}
sale_data <- read.table(here("rawdata/june1data.csv"), head=T, sep=",")

# replace "dis " with "dis"
sale_data <- sale_data %>%
  mutate(Intervention = replace(Intervention, Intervention == "dis ", "dis"))

#convert DofW, Site and Intervention columns to factor
sale_data <- sale_data %>% 
  mutate_at(c('DofW', 'Site', 'Intervention'), as.factor)
```

```{r fig.height=3}
#missing data, overall
plot_missing_values_proportions(df=sale_data) +
  ggtitle("",subtitle = "Figure 1: The proportion of missing values for all columns in the data set.")
```

```{r}
# data missingness  by Site
count_missing<- sale_data %>%
    group_by(Site) %>%
    summarise(across(.cols = where(~ any(is.na(.x))), ~sum(is.na(.x))))

# Table
kable(count_missing, caption = "Number of missing observations for columns with missing data present by site")
```

To explore the change of daily sales of zero-calorie beverages and bottled sugared beverages over time, time series plot for `ZeroCal` and `Sugary` can be made for each of the three sites (see Figure 2 as an example). It is important to note that the increase in the raw counts of say zero-calorie beverages being sold does not necessarily mean the decrease in the sales of sugared beverages. It could be the case that more customs came to the shops that day so that sales of all things tended to be higher. Therefore, in addition to visualize the change of daily sales using the raw counts, it is suggested to also explore the change of daily sales in percentage terms (i.e. $\frac{\text{sales of zero-calorie beverages}}{\text{sales of zero-calorie beverages + sales of sugared beverages}}*100\%$ and $\frac{\text{sales of sugared beverages}}{\text{sales of zero-calorie beverages + sales of sugared beverages}}*100\%$). Change in the percentage can better represent the change in zero-calorie beverages consumption relative to the sugared beverages consumption, and vice versa. 

```{r}
# delete rows with missing data in both ZeroCal and Sugary
sale_data_c <- sale_data %>%
  filter(!(is.na(ZeroCal) | is.na(Sugary)))

# Plot Daily sales of ZeroCal
ggplot(data=sale_data_c, 
       aes(x=Count, y=ZeroCal, group=Site)) +
  geom_line(aes(color=Intervention)) + 
  geom_point(aes(color=Intervention), size=0.5) + 
  facet_wrap( ~ Site, ncol = 1, scales = "free_y") + 
  xlab("Day") + 
  ylab("Daily sales of zero-calorie beverages") +
  ggtitle("",subtitle = "Figure 2: Daily sales of zero-calorie beverages over time for \neach of the three sites")
```

To compare the consumption of a selected type of beverages (zero-calorie beverages or sugary beverages) among different intervention types, boxplots with sales in percentage terms as y-axis and with intervention as x-axis can be made (see Figure 3 as an example). Similarly, boxplots can also be used to compare the consumption of a selected type of beverages among days of week to see if there are any patterns.

```{r}
sale_data_c$Sugary_percent <-
  sale_data_c$Sugary/(sale_data_c$Sugary+sale_data_c$ZeroCal)*100
sale_data_c$ZeroCal_percent <-
  sale_data_c$ZeroCal/(sale_data_c$Sugary+sale_data_c$ZeroCal)*100

#Create a new Intervention column to make boxplots
sale_data_c$Intervention_new <- sale_data_c$Intervention
# replace the "preint" in the 2nd half of the study with "preint2"
# replace the "follow" in the 2nd half of the study with "follow2"
levels(sale_data_c$Intervention_new) <- c(levels(sale_data_c$Intervention_new), "preint2", "follow2") #first increase the levels of Intervention_new

sale_data_c <- sale_data_c %>%
  mutate(Intervention_new = replace(Intervention_new, Count>=110 & Intervention_new == "preint", "preint2"), 
         Intervention_new = replace(Intervention_new, Count>=110 & Intervention_new == "follow", "follow2"))

# reorder the levels
sale_data_c$Intervention_new <- fct_relevel(sale_data_c$Intervention_new,
                                            c("preint", "dismes", "dis", "follow", "preint2", "cal", "excer", "both", "follow2", "wash", "wash2"))

#boxplots
ggplot(data=sale_data_c %>% 
         filter(Intervention_new!="wash" & Intervention_new !="wash2"), 
       aes(x=Intervention_new, y=ZeroCal_percent)) +
  geom_boxplot() + 
  facet_wrap( ~ Site, ncol = 3, scales = "free_y") + 
  xlab("Intervention") + 
  ylab("Daily percentage of \nzero-calorie beverages sales") +
  ggtitle("",subtitle = "Figure 3: Boxplots of daily percentage of zero-calorie beverages sales for \neach of the three sites") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```



# Formal Analysis


# Conclusions

\newpage
# References

\newpage
# Statistical Appendix
\beginAppendix

```{r}
# data missingness  by Site
count_missing<- sale_data %>%
    group_by(Site, Intervention) %>%
    summarise(across(.cols = where(~ any(is.na(.x))), ~sum(is.na(.x))))

# Table
kable(count_missing, caption = "Number of missing observations for columns with missing data present by site and intervention type.")
 
```